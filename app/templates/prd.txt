# PRD - Sistema GMM (Gest√£o Moderna de Manuten√ß√£o)

## Vis√£o Geral do Sistema

Sistema web integrado para gest√£o de manuten√ß√£o, controle de ponto, estoque e servi√ßos terceirizados em academias/unidades m√∫ltiplas.

---

## M√ìDULO 1: Autentica√ß√£o e Controle de Acesso

### 1.1 Funcionalidades
- Login com username/senha
- Tipos de usu√°rio: admin, tecnico, gerente, comprador, prestador
- Controle de sess√£o com Flask-Login
- Restri√ß√£o de IP por unidade (decorators)
- √öltimo acesso registrado

### 1.2 Regras de Neg√≥cio
- RN001: Admin acessa todas as funcionalidades
- RN002: T√©cnicos acessam apenas suas OS e estoque
- RN003: Compradores acessam apenas painel de compras
- RN004: Check-in s√≥ permitido em IPs autorizados da unidade

### 1.3 Endpoints
```
GET  /auth/login
POST /auth/login
GET  /auth/logout
```

---

## M√ìDULO 2: Gest√£o de Ordens de Servi√ßo (OS)

### 2.1 Funcionalidades Core
- Cria√ß√£o de OS com fotos (antes/depois)
- Vincula√ß√£o a equipamentos e unidades
- Rastreamento de pe√ßas consumidas
- C√°lculo autom√°tico de custos
- Adi√ß√£o de servi√ßos terceirizados
- Conclus√£o com solu√ß√£o documentada

### 2.2 Regras de Neg√≥cio
- RN005: N√∫mero OS no formato `OS-{ANO}-{SEQUENCIAL}`
- RN006: M√°ximo 10 fotos por upload (5MB cada)
- RN007: N√£o adicionar pe√ßas em OS conclu√≠da/cancelada
- RN008: Estoque descontado automaticamente no consumo
- RN009: Alerta se prazo vence em <24h

### 2.3 Endpoints
```
GET  /os/nova
POST /os/nova
GET  /os/<id>
POST /os/<id>/concluir
POST /os/<id>/adicionar-peca
POST /os/<id>/adicionar-tarefa-externa
POST /os/<id>/editar
GET  /os/api/equipamentos/filtro
```

### 2.4 Integra√ß√µes
- Estoque (consumo de pe√ßas)
- Terceirizados (chamados externos)
- Notifica√ß√µes (alertas de prazo)

---

## M√ìDULO 3: Gest√£o de Estoque ‚≠ê (FOCO DESTE PRD)

### 3.1 Vis√£o Geral
Sistema multi-unidade com controle descentralizado, solicita√ß√µes de compra e aprova√ß√£o centralizada.

### 3.2 Funcionalidades Principais

#### 3.2.1 Controle de Saldo por Unidade
**Objetivo**: Rastrear estoque f√≠sico em cada local

**Tabela**: `estoque_saldo`
- `estoque_id` (FK)
- `unidade_id` (FK)
- `quantidade` (Decimal)
- `localizacao` (texto) - Ex: "Prateleira A3"

**Regras**:
- RN010: Cada item pode ter saldo em m√∫ltiplas unidades
- RN011: Consumo desconta do saldo local da unidade da OS
- RN012: `Estoque.quantidade_atual` = soma de todos os saldos
- RN013: Alerta quando `quantidade_atual <= quantidade_minima`

#### 3.2.2 Transfer√™ncia Entre Unidades
**Objetivo**: Permitir movimenta√ß√£o f√≠sica de pe√ßas entre locais

**Tabela**: `solicitacoes_transferencia`
- `estoque_id` (FK)
- `unidade_origem_id` (FK)
- `unidade_destino_id` (FK)
- `solicitante_id` (FKUsu√°rio)
- `quantidade` (Decimal)
- `status` (pendente | aprovada | rejeitada | concluida)
- `data_solicitacao` (DateTime)
- `data_conclusao` (DateTime, nullable)
- `observacao` (String 255)

**Fluxos**:

**Fluxo A - T√©cnico Solicita**:
1. T√©cnico em Unidade B precisa de item com saldo 0 local
2. Verifica que Unidade A tem saldo dispon√≠vel
3. Clica "Transferir" no painel de estoque
4. Preenche origem, destino, quantidade
5. Sistema cria registro com `status='pendente'`
6. Gerente/Admin recebe notifica√ß√£o (futuro)
7. Gerente aprova ‚Üí status='aprovada' ‚Üí executa movimenta√ß√£o f√≠sica
8. Sistema registra:
   - Sa√≠da em `movimentacoes_estoque` (origem, tipo='saida')
   - Entrada em `movimentacoes_estoque` (destino, tipo='entrada')
   - Atualiza `estoque_saldo` de ambas unidades

**Fluxo B - Admin/Gerente Executa Direto**:
1. Admin clica "Transferir"
2. Seleciona origem/destino/qtd
3. Sistema valida saldo origem
4. Executa transfer√™ncia imediatamente (`aprovacao_automatica=True`)
5. Status j√° vai para 'concluida'

**Regras**:
- RN014: Origem e destino devem ser diferentes
- RN015: Validar saldo dispon√≠vel na origem antes de aprovar
- RN016: Admin/Gerente podem aprovar ou executar direto

**Endpoint**:
```python
POST /os/api/estoque/transferir
Body: {
  estoque_id: int,
  unidade_origem_id: int,
  unidade_destino_id: int,
  quantidade: float,
  observacao?: string
}
Response: {
  success: bool,
  msg: string
}
```

#### 3.2.3 Entrada de Estoque (Recebimento)
**Objetivo**: Registrar chegada de novas pe√ßas (compras, doa√ß√µes, devolu√ß√µes)

**Funcionalidade**:
- Bot√£o "Nova Entrada" no painel de estoque
- Modal com:
  - Busca de pe√ßa (autocomplete)
  - Sele√ß√£o de unidade destino
  - Quantidade
  - Valor unit√°rio (opcional, atualiza `Estoque.valor_unitario`)
  - Motivo/Observa√ß√£o (Ex: "NF 12345")

**Fluxo**:
1. Usu√°rio clica "Nova Entrada"
2. Busca item pelo nome/c√≥digo
3. Seleciona unidade onde material chegou
4. Informa quantidade e valor
5. Sistema:
   - Cria/Atualiza registro em `estoque_saldo`
   - Incrementa `quantidade` do saldo local
   - Registra `MovimentacaoEstoque` (tipo='entrada')
   - Atualiza `quantidade_atual` global (trigger autom√°tico)

**Regras**:
- RN017: Entrada sempre vinculada a uma unidade espec√≠fica
- RN018: Se unidade n√£o informada, usa `usuario.unidade_padrao_id`
- RN019: Valor unit√°rio opcional (mas recomendado)

**Endpoint**:
```python
POST /os/api/estoque/entrada
Body: {
  estoque_id: int,
  unidade_id: int,
  quantidade: float,
  motivo?: string,
  valor_novo?: float
}
Response: {
  success: bool,
  novo_saldo: float
}
```

#### 3.2.4 Solicita√ß√£o de Compra ‚≠ê (NOVA FUNCIONALIDADE)
**Objetivo**: T√©cnicos podem solicitar compra de itens sem saldo

**Quando Usar**:
- Item n√£o tem saldo suficiente em nenhuma unidade
- Pe√ßa atingiu estoque m√≠nimo
- Necessidade urgente identificada em OS

**Tabela Existente**: `pedidos_compra`
```sql
id INTEGER PRIMARY KEY
fornecedor_id INTEGER (nullable inicialmente)
estoque_id INTEGER FK
quantidade DECIMAL(10,3)
data_solicitacao DATETIME
data_chegada DATETIME (nullable)
status VARCHAR(20) -- pendente, aprovado, encomendado, entregue, cancelado
```

**Fluxo - T√©cnico Solicita**:
1. Na tela de OS, ao tentar adicionar pe√ßa sem saldo:
   - Sistema exibe mensagem: "Estoque insuficiente"
   - Aparece bot√£o "Solicitar Compra"
2. T√©cnico clica ‚Üí Modal abre
3. Preenche quantidade necess√°ria
4. Sistema cria `PedidoCompra`:
   - `status='pendente'`
   - `fornecedor_id=NULL` (ser√° definido na aprova√ß√£o)
   - `estoque_id` e `quantidade` preenchidos
5. Notifica√ß√£o enviada ao setor de compras

**Fluxo - Solicita√ß√£o Direta no Estoque**:
1. No painel `/os/estoque/painel`
2. Item com badge "BAIXO" tem bot√£o "Comprar"
3. Clica ‚Üí abre modal r√°pido
4. Informa quantidade ‚Üí Cria pedido pendente

**Endpoint**:
```python
POST /os/<os_id>/solicitar-compra-peca
Body: {
  estoque_id: int,
  quantidade: float
}
Response: {
  success: bool,
  mensagem: "Solicita√ß√£o criada (Pedido #123)"
}

# OU diretamente do estoque:
POST /os/api/estoque/solicitar-compra
Body: {
  estoque_id: int,
  quantidade: float
}
```

**Regras**:
- RN020: Qualquer usu√°rio logado pode solicitar compra
- RN021: Sistema busca primeiro fornecedor vinculado ao item (CatalogoFornecedor)
- RN022: Se nenhum fornecedor vinculado, pega o primeiro da base (ou gera erro)
- RN023: Pedidos pendentes v√£o para fila de aprova√ß√£o do comprador

---

### 3.3 Painel de Estoque (UI)

**Rota**: `/os/painel-estoque`

**Elementos Visuais**:
```html
<table>
  <tr>
    <td>Nome / C√≥digo</td>
    <td>Categoria</td>
    <td>
      Saldo Total: 45 UN
      <small>Meu Local: 12 UN</small> <!-- Se t√©cnico -->
      <small>Distribui√ß√£o: A(20) B(15) C(10)</small> <!-- Se admin -->
    </td>
    <td>Valor Unit.</td>
    <td>
      <badge>BAIXO</badge> + Bot√£o "Comprar"
      OU
      <badge>Normal</badge>
    </td>
    <td>
      <dropdown>
        - Transferir
        - Ajuste R√°pido
      </dropdown>
    </td>
  </tr>
</table>
```

**Bot√µes Principais**:
- üÜï **Nova Entrada**: Abre modal de recebimento
- üìã **Hist√≥rico**: Lista movimenta√ß√µes (futuro)
- üõí **Solicitar Compra**: Abre modal de pedido em lote (futuro)

---

### 3.4 Intera√ß√£o com OS

**Cen√°rio 1 - Estoque Dispon√≠vel Localmente**:
1. T√©cnico em OS da Unidade A
2. Adiciona "Cabo de A√ßo" (5 unidades)
3. Sistema verifica `estoque_saldo` onde `unidade_id=A`
4. Saldo local = 10 ‚Üí OK
5. Desconta 5 do saldo local
6. Cria `MovimentacaoEstoque` (tipo='consumo', unidade_id=A)

**Cen√°rio 2 - Estoque Insuficiente Local, Dispon√≠vel Global**:
1. T√©cnico em OS da Unidade B
2. Tenta adicionar "Rolamento" (3 unidades)
3. Saldo local B = 0, mas saldo global = 15 (A tem 15)
4. Sistema retorna erro:
   ```json
   {
     "success": false,
     "erro": "Estoque insuficiente na Unidade B. Dispon√≠vel: 0 UN. (H√° 15 UN no estoque global. Solicite transfer√™ncia)"
   }
   ```
5. Interface exibe bot√£o "Solicitar Transfer√™ncia"
6. Abre modal pr√©-preenchido:
   - Origem: Unidade A (detectada automaticamente)
   - Destino: Unidade B (da OS)
   - Item: Rolamento
   - Qtd: 3

**Cen√°rio 3 - Sem Estoque em Nenhuma Unidade**:
1. Saldo global = 0
2. Sistema retorna:
   ```json
   {
     "success": false,
     "erro": "Item indispon√≠vel. Solicite compra."
   }
   ```
3. Interface exibe bot√£o "Solicitar Compra"
4. Abre modal de pedido

---

## M√ìDULO 4: Central de Compras ‚≠ê (NOVO)

### 4.1 Vis√£o Geral
Painel exclusivo para aprova√ß√£o e gest√£o de pedidos de compra solicitados por t√©cnicos/usu√°rios.

### 4.2 Rota Principal
```
GET /admin/compras
```

**Permiss√µes**:
- `current_user.tipo == 'comprador'` OU `admin`

### 4.3 Interface (Abas)

#### Aba 1: Pendentes
**Objetivo**: Aprovar ou rejeitar solicita√ß√µes

**Tabela**:
| Item | Qtd Solic. | Data | Status Estoque | A√ß√µes |
|------|-----------|------|----------------|-------|
| Cabo de A√ßo | 50 M | 18/12 10:30 | üî¥ Cr√≠tico | ‚úÖ Aprovar ‚ùå Rejeitar |
| Fus√≠vel 10A | 100 UN | 18/12 09:15 | ‚ö†Ô∏è Reposi√ß√£o | ‚úÖ Aprovar ‚ùå Rejeitar |

**Fluxo - Aprovar**:
1. Comprador clica "Aprovar"
2. Modal abre:
   - **Selecionar Fornecedor**: Dropdown com fornecedores vinculados ao item
     - Exibe: Nome | Prazo m√©dio | Hist√≥rico de entregas
     - Ordenado por menor prazo
   - **Previs√£o de Chegada**: Input date (calculado automaticamente com base no prazo)
3. Comprador confirma
4. Sistema:
   - Atualiza `status='aprovado'`
   - Define `fornecedor_id`
   - Define `data_chegada` estimada
   - Envia email/notifica√ß√£o ao fornecedor (futuro)

**Fluxo - Rejeitar**:
1. Clica "Rejeitar"
2. Confirma em modal simples
3. `status='cancelado'`
4. Notifica solicitante (futuro)

**Endpoints**:
```python
POST /admin/api/compras/<id>/aprovar
Body: {
  fornecedor_id: int,
  data_chegada: "YYYY-MM-DD"
}

POST /admin/api/compras/<id>/rejeitar
```

#### Aba 2: A Receber (Aprovados/Em Tr√¢nsito)
**Objetivo**: Confirmar recebimento f√≠sico

**Tabela**:
| Pedido # | Item | Fornecedor | Previs√£o | A√ß√£o |
|----------|------|-----------|----------|------|
| #123 | Rolamento 608ZZ | FornX | 20/12 | üì¶ Receber |
| #124 | Silicone Spray | FornY | 22/12 | üì¶ Receber |

**Fluxo - Receber**:
1. Comprador clica "Receber"
2. Confirma recebimento
3. Sistema:
   - Atualiza `status='entregue'`
   - Define `data_chegada=now()` (data real)
   - **IMPORTANTE**: Incrementa saldo do estoque
     - Cria/Atualiza `EstoqueSaldo` na unidade do comprador
     - OU abre modal para selecionar unidade destino
   - Registra `MovimentacaoEstoque` (tipo='entrada')
   - Atualiza prazo m√©dio do fornecedor:
     ```python
     dias_reais = (data_chegada - data_solicitacao).days
     fornecedor.prazo_medio = (prazo_medio * entregas + dias_reais) / (entregas + 1)
     fornecedor.total_pedidos_entregues += 1
     ```

**Endpoint**:
```python
POST /admin/api/compras/<id>/receber
Body: {
  unidade_destino_id?: int  # Opcional, se quiser definir
}
Response: {
  success: bool
}
```

#### Aba 3: Hist√≥rico
**Objetivo**: Auditoria de compras passadas

**Filtros**:
- Por data (√∫ltimos 30/60/90 dias)
- Por fornecedor
- Por status (entregue, cancelado)

**Exibi√ß√£o**:
- Timeline visual
- Gr√°fico de tempo m√©dio de entrega por fornecedor
- Total gasto no per√≠odo

### 4.4 Regras de Neg√≥cio
- RN024: Apenas comprador/admin acessa `/admin/compras`
- RN025: Pedido aprovado n√£o pode ser rejeitado
- RN026: Recebimento atualiza automaticamente estoque
- RN027: Hist√≥rico imut√°vel (audit trail)
- RN028: Prazo m√©dio do fornecedor recalculado a cada entrega

### 4.5 Integra√ß√µes
- **Estoque**: Recebimento incrementa saldo
- **Fornecedores**: Atualiza m√©tricas de performance
- **Notifica√ß√µes**: Alerta solicitante quando pedido chegar (futuro)

---

## M√ìDULO 5: Gest√£o de Fornecedores

### 5.1 Funcionalidades Existentes
- Cadastro de fornecedores
- Vincula√ß√£o de pe√ßas ao cat√°logo
- Defini√ß√£o de pre√ßo e prazo por item
- API de busca de fornecedores por pe√ßa

### 5.2 Melhorias Propostas (Futuro)
- Ranking autom√°tico por prazo/confiabilidade
- Hist√≥rico de cota√ß√µes
- Integra√ß√£o com sistema do fornecedor (API)
- Avalia√ß√£o p√≥s-entrega

---

## M√ìDULO 6: Notifica√ß√µes e Alertas

### 6.1 Tipos de Notifica√ß√µes
1. **OS Vencendo**: Prazo < 24h
2. **Estoque Baixo**: qtd_atual <= qtd_minima
3. **Pedido Aprovado**: Para solicitante
4. **Pedido Recebido**: Para solicitante
5. **Transfer√™ncia Aprovada**: Para solicitante

### 6.2 Canais
- In-app (banner no dashboard)
- Email (futuro)
- Push notification (futuro)

### 6.3 Endpoint
```
GET /api/notifications
Response: {
  count: int,
  alerts: [
    {
      type: "urgent" | "warning" | "info",
      message: string,
      url: string,
      timestamp: ISO8601
    }
  ]
}
```

---

## M√ìDULO 7: Terceirizados (Existente)

### 7.1 Funcionalidades
- Cadastro de prestadores
- Cria√ß√£o de chamados externos
- Notifica√ß√£o via WhatsApp (MegaAPI)
- Cobran√ßa autom√°tica de atrasos
- Hist√≥rico de servi√ßos

*(Sem altera√ß√µes propostas neste PRD)*

---

## M√ìDULO 8: Relat√≥rios e KPIs

### 8.1 KPIs Atuais
- MTTR M√©dio (Mean Time To Repair)
- OSs Conclu√≠das
- Estoque Baixo (count)

### 8.2 Novos KPIs Propostos
- **Giro de Estoque**: Sa√≠das / Estoque M√©dio (por per√≠odo)
- **Taxa de Transfer√™ncias**: Transfer√™ncias / Total Movimenta√ß√µes
- **Tempo M√©dio de Aprova√ß√£o de Compra**: M√©dia (data_aprovacao - data_solicitacao)
- **Acuracidade de Prazo do Fornecedor**: % entregas no prazo
- **Custo M√©dio por OS**: Total pe√ßas consumidas / OSs conclu√≠das

---

## Fluxo Completo: Da Solicita√ß√£o ao Recebimento

### Cen√°rio: T√©cnico precisa de rolamento sem estoque

1. **[OS] T√©cnico tenta adicionar pe√ßa**
   ```
   POST /os/123/adicionar-peca
   Body: {estoque_id: 45, quantidade: 2}
   ‚Üí Erro: "Estoque insuficiente"
   ```

2. **[OS] T√©cnico solicita compra**
   ```
   POST /os/123/solicitar-compra-peca
   Body: {estoque_id: 45, quantidade: 2}
   ‚Üí Cria PedidoCompra #789 (status='pendente')
   ‚Üí Toast: "Solicita√ß√£o criada!"
   ```

3. **[Compras] Comprador recebe alerta**
   ```
   GET /admin/compras (aba Pendentes)
   ‚Üí V√™ pedido #789 na lista
   ```

4. **[Compras] Comprador aprova**
   ```
   Clica "Aprovar" ‚Üí Modal abre
   Seleciona: Fornecedor XYZ (prazo 5 dias)
   Data chegada: 23/12/2025
   POST /admin/api/compras/789/aprovar
   ‚Üí status='aprovado'
   ‚Üí Notifica√ß√£o para t√©cnico (futuro)
   ```

5. **[Compras] Material chega**
   ```
   Dia 23/12:
   Comprador acessa aba "A Receber"
   Clica "Receber" no pedido #789
   Modal: "Em qual unidade chegou?" ‚Üí Seleciona Unidade B
   POST /admin/api/compras/789/receber
   ‚Üí Cria EstoqueSaldo (unidade_id=B, quantidade=2)
   ‚Üí Cria MovimentacaoEstoque (tipo='entrada')
   ‚Üí Atualiza prazo_medio do fornecedor
   ‚Üí status='entregue'
   ```

6. **[OS] T√©cnico usa a pe√ßa**
   ```
   Volta √† OS #123
   POST /os/123/adicionar-peca
   Body: {estoque_id: 45, quantidade: 2}
   ‚Üí Agora tem saldo local ‚Üí Sucesso!
   ‚Üí Desconta de EstoqueSaldo (unidade B)
   ```

---

## Modelo de Dados - Resumo

```mermaid
erDiagram
    Estoque ||--o{ EstoqueSaldo : "tem_saldo_em"
    EstoqueSaldo }o--|| Unidade : "localizado_em"
    
    Estoque ||--o{ PedidoCompra : "pedidos"
    PedidoCompra }o--|| Fornecedor : "fornecido_por"
    
    Estoque ||--o{ MovimentacaoEstoque : "movimenta"
    MovimentacaoEstoque }o--|| OrdemServico : "vinculada_a"
    MovimentacaoEstoque }o--|| Unidade : "ocorreu_em"
    
    SolicitacaoTransferencia }o--|| Estoque : "transfere"
    SolicitacaoTransferencia }o--|| Unidade : "origem"
    SolicitacaoTransferencia }o--|| Unidade : "destino"
    SolicitacaoTransferencia }o--|| Usuario : "solicitado_por"
```

---

## Prioriza√ß√£o de Desenvolvimento

### Sprint 1 (Cr√≠tico) ‚≠ê
- [x] Tabela `estoque_saldo` implementada
- [x] L√≥gica de consumo por unidade
- [ ] **Nova Entrada de Estoque** (modal + endpoint)
- [ ] **Solicita√ß√£o de Compra** (bot√£o + modal + endpoint)

### Sprint 2 (Alta Prioridade)
- [ ] **Central de Compras** (painel completo)
- [ ] Aprova√ß√£o de pedidos
- [ ] Recebimento com atualiza√ß√£o de estoque
- [ ] Transfer√™ncia entre unidades (solicita√ß√£o)

### Sprint 3 (M√©dia Prioridade)
- [ ] Aprova√ß√£o de transfer√™ncias (workflow)
- [ ] Hist√≥rico de movimenta√ß√µes
- [ ] Relat√≥rio de giro de estoque
- [ ] M√©tricas de fornecedores

### Sprint 4 (Baixa Prioridade / Futuro)
- [ ] Notifica√ß√µes por email
- [ ] Dashboard anal√≠tico avan√ßado
- [ ] Integra√ß√£o API fornecedores
- [ ] App mobile (React Native)

---

## Seguran√ßa e Auditoria

### Logs Obrigat√≥rios
- Todas as movimenta√ß√µes de estoque (`MovimentacaoEstoque`)
- Aprova√ß√µes/Rejei√ß√µes de pedidos
- Transfer√™ncias entre unidades
- Altera√ß√µes em valores unit√°rios

### Constraints de Seguran√ßa
- Usu√°rio s√≥ v√™ saldo da pr√≥pria unidade (exceto admin)
- Comprador n√£o pode editar estoque diretamente
- T√©cnico n√£o pode aprovar pr√≥prias transfer√™ncias
- Hist√≥rico de movimenta√ß√µes imut√°vel

---
