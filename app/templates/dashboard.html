{% extends "base.html" %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-3">
        {% if current_user.tipo == 'tecnico' %}
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center d-flex flex-column justify-content-center p-4">
                <div class="mb-3">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex align-items-center justify-content-center"
                        style="width: 64px; height: 64px;">
                        <i class="bi bi-stopwatch fs-2"></i>
                    </div>
                </div>
                <h5 class="fw-bold mb-1">Meu Ponto</h5>

                {% if registro_aberto %}
                <span class="badge bg-success bg-opacity-10 text-success align-self-center mb-3">Em Expediente</span>
                <p class="text-muted small mb-4">Entrada registrada às {{
                    registro_aberto.data_hora_entrada.strftime('%H:%M') }}</p>
                <form action="{{ url_for('ponto.checkout') }}" method="POST">
                    <input type="hidden" name="registro_id" value="{{ registro_aberto.id }}">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-box-arrow-right"></i> Registrar Saída
                    </button>
                </form>
                {% else %}
                <span class="badge bg-secondary align-self-center mb-3">Não Iniciado</span>
                <form action="{{ url_for('ponto.checkin') }}" method="POST" id="formCheckin">
                    <input type="hidden" name="latitude" id="lat">
                    <input type="hidden" name="longitude" id="lon">
                    <select name="unidade_id" class="form-select mb-3" required>
                        <option value="" selected disabled>Selecionar Local</option>
                        {% for u in unidades %}
                        <option value="{{ u.id }}">{{ u.nome }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="getLocationAndSubmit()" class="btn btn-primary w-100">
                        <i class="bi bi-geo-alt me-2"></i> Check-in
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <a href="{{ url_for('os.nova_os') }}"
            class="btn btn-primary btn-lg rounded-circle shadow-lg position-fixed bottom-0 end-0 m-3 d-lg-none"
            style="width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; z-index: 100;">
            <i class="bi bi-plus-lg fs-4"></i>
        </a>

        <div class="d-none d-lg-block mt-4">
            <a href="{{ url_for('os.nova_os') }}" class="btn btn-primary w-100 py-3 mb-3 shadow-sm">
                <i class="bi bi-plus-lg me-2"></i> Nova OS
            </a>

            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted fw-bold text-uppercase">Pendências</small>
                        <span class="badge bg-warning text-dark">{{ minhas_os | selectattr("status", "equalto",
                            "aberta") | list | length }}</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-warning" style="width: 70%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">Ordens de Serviço</h3>
            <div class="d-none d-md-block w-25">
                <input type="text" class="form-control form-control-sm" placeholder="Filtrar nesta lista...">
            </div>
        </div>

        <table class="table table-responsive-stack table-hover">
            <thead>
                <tr>
                    <th style="width: 10%;">ID</th>
                    <th style="width: 30%;">Equipamento / Local</th>
                    <th style="width: 15%;">Prioridade</th>
                    <th style="width: 15%;">Status</th>
                    <th style="width: 20%;" class="text-end">Ação</th>
                </tr>
            </thead>
            <tbody>
                {% for os in minhas_os %}
                <tr>
                    <td data-label="OS ID">
                        <span class="fw-bold text-primary">#{{ os.numero_os }}</span>
                    </td>
                    <td data-label="Equipamento">
                        <div class="fw-600">{{ os.equipamento_rel.nome if os.equipamento_rel else 'Geral' }}</div>
                        <small class="text-muted">{{ os.unidade.nome }}</small>
                    </td>
                    <td data-label="Prioridade">
                        {% if os.prioridade == 'urgente' %}
                        <span class="badge bg-danger bg-opacity-10 text-danger"><i class="bi bi-fire me-1"></i>
                            Urgente</span>
                        {% elif os.prioridade == 'alta' %}
                        <span class="badge bg-warning bg-opacity-10 text-warning">Alta</span>
                        {% else %}
                        <span class="badge bg-info bg-opacity-10 text-info">Normal</span>
                        {% endif %}
                    </td>
                    <td data-label="Status">
                        {% if os.status == 'aberta' %}
                        <span class="badge bg-warning text-dark">Aberta</span>
                        {% else %}
                        <span class="badge bg-success">Concluída</span>
                        {% endif %}
                    </td>
                    <td data-label="Ação">
                        <a href="{{ url_for('os.detalhes', id=os.id) }}"
                            class="btn btn-sm btn-outline-primary w-100-mobile">
                            Detalhes
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="text-muted d-flex flex-column align-items-center">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <span>Nenhuma ordem de serviço encontrada.</span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function getLocationAndSubmit() {
        const btn = document.querySelector('#formCheckin button');
        const form = document.getElementById('formCheckin');

        // Loading state button
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Localizando...';

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                document.getElementById('lat').value = position.coords.latitude;
                document.getElementById('lon').value = position.coords.longitude;
                form.submit();
            }, function (error) {
                // Tratamento de erro com Toast Nativo
                ToastModule.show("Erro ao obter localização. Verifique as permissões.", "danger");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }, { timeout: 10000 });
        } else {
            ToastModule.show("Geolocalização não suportada.", "danger");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
</script>
{% endblock %}